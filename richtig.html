<!DOCTYPE html>
<html>
<head>
  <title>SAP App Task</title>
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    .app-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-image: url('img/Home_GL_empty.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;


      padding: 100px 0 80px 45px;
          /*top  right bottom left */
      box-sizing: border-box;
    }

    .app-grid {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 80px;
    }

    .app-grid-top,
    .app-grid-bottom {
      display: grid;
      grid-template-columns: repeat(3, 180px);
      grid-auto-rows: 140px;
      gap: 30px 40px;
    }

    .app-button {
      width: 180px;
      height: 140px;
      background-color: white;
      border: 2px solid #ccc;
      border-radius: 10px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      text-align: center;
      padding: 10px;
    }

    .app-box {
      background-color: white;
      border-radius: 16px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.15);
      text-align: center;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      width: 180px;
      height: 140px;
    }

    .symbol {
      margin-top: 10px;
      font-size: 20px;
      color: #555;
    }

    .fixation-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: white;
      font-size: 60px;
    }

    .confirm-box {
      position: absolute;
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
  <script>
    const jsPsych = initJsPsych({
      on_finish: () => jsPsych.data.displayData()
    });

    const preload = {
      type: jsPsychPreload,
      images: ['img/Home_GL_empty.png']
    };

    const instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<p>Willkommen zum Experiment.</p><p>Sie sehen gleich eine Ziel-App. Merken Sie sich diese und klicken Sie sie im Anschluss im Suchbildschirm an. Danach erscheint ein "Bestätigen"-Knopf, den Sie ebenfalls klicken müssen.</p>`,
      choices: ['Weiter']
    };

    const showTarget = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<div style="text-align:center;"><div class="app-box">App 1<div class="symbol">▲</div></div></div>`,
      choices: ['Weiter']
    };

    const fixation = {
      type: jsPsychHtmlButtonResponse,
      stimulus: '<div class="fixation-screen">+</div>',
      choices: "NO_KEYS",
      trial_duration: 1000
    };

    function createTrial() {
      let apps = [];
      const symbols = ['▲', '■', '●', '◆', '★', '✚', '☀', '☁', '♞'];
      for (let i = 0; i < 9; i++) {
        apps.push({
          name: `App ${i + 1}`,
          symbol: symbols[i],
          isTarget: i === 0
        });
      }
      return jsPsych.randomization.shuffle(apps);
    }

    function getSearchTrial(apps) {
      return {
        type: jsPsychHtmlButtonResponse,
        stimulus: () => {
          let html = '<div class="app-container"><div class="app-grid">';
          html += '<div class="app-grid-top">';
          for (let i = 0; i < 6; i++) {
            const app = apps[i];
            html += `<div class="app-box" data-index="${i}" onclick="selectApp(${i})">${app.name}<div class="symbol">${app.symbol}</div></div>`;
          }
          html += '</div><div class="app-grid-bottom">';
          for (let i = 6; i < 9; i++) {
            const app = apps[i];
            html += `<div class="app-box" data-index="${i}" onclick="selectApp(${i})">${app.name}<div class="symbol">${app.symbol}</div></div>`;
          }
          html += '</div></div></div>';
          return html;
        },
        choices: ['Continue'],
        button_html: '<button id="hidden-button" style="display:none;">%choice%</button>',
        on_start: () => {
          window.appClicked = false;
        },
        on_load: function () {
          const trialApps = jsPsych.timelineVariable('apps');
          window.selectApp = function (index) {
            if (window.appClicked) return;
            const selected = trialApps[index];
            if (selected.isTarget) {
              window.appClicked = true;
              const pause = jsPsych.randomization.sampleWithoutReplacement([200, 300, 400, 500, 600], 1)[0];
              setTimeout(() => showConfirmButton(() => jsPsych.finishTrial()), pause);
            }
          };
        }
      };
    }

    function showConfirmButton(callback) {
      const confirm = document.createElement('div');
      confirm.className = 'confirm-box';
      confirm.innerText = 'Bestätigen';
      const randX = Math.random() * (window.innerWidth - 150);
      const randY = Math.random() * (window.innerHeight - 50);
      confirm.style.left = `${randX}px`;
      confirm.style.top = `${randY}px`;
      document.body.appendChild(confirm);
      confirm.onclick = () => {
        confirm.remove();
        callback();
      };
    }

    const timeline = [preload, instructions, showTarget, fixation];
    for (let i = 0; i < 10; i++) {
      const trialApps = createTrial();
      timeline.push({
        timeline: [getSearchTrial(trialApps), fixation],
        timeline_variables: [{apps: trialApps}]
      });
    }
    jsPsych.run(timeline);
  </script>
</body>
</html>
