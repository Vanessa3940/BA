<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>

    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
      .image-container {
        position: relative;
        width: 1100px;
        margin: auto;
      }

      .target-box {
        position: absolute;
        border: 3px solid red;
        background-color: rgba(255, 0, 0, 0.0); /* durchsichtig, aber klickbar */
        cursor: pointer;
      }

      .hidden-button {
        display: none;
      }
    </style>
  </head>
  <body></body>
  <script>
    const jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });

    const timeline = [];

    const preload = {
      type: jsPsychPreload,
      images: ['img/Bild1.png', 'img/Bild2.png', 'img/Bild3.png', 'img/Bild4.png']
    };
    timeline.push(preload);

    const welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "Welcome to the experiment. Press any key to begin."
    };
    timeline.push(welcome);

    const instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p>In this experiment, click the red square on each image to continue.</p>
        <p>The red square may be in different places and sizes depending on the image.</p>
        <p>Press any key to begin.</p>
      `
    };
    timeline.push(instructions);

    // Test-Stimuli mit Position und Größe
    const test_stimuli = [
      {
        stimulus: "img/Bild1.png",
        box_top: 450,
        box_left: 950,
        box_width: 48,
        box_height: 20
      },
      {
        stimulus: "img/Bild2.png",
        box_top: 494,
        box_left: 575,
        box_width: 40,
        box_height: 17
      },
      {
        stimulus: "img/Bild3.png",
        box_top: 654,
        box_left: 956,
        box_width: 71,
        box_height: 13
      },
      {
        stimulus: "img/Bild4.png",
        box_top: 433,
        box_left: 555,
        box_width: 39,
        box_height: 14
      }
    ];

    const fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: function(){
        return jsPsych.randomization.sampleWithoutReplacement(
          [250, 500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
      },
      data: { task: 'fixation' }
    };

    const test = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        const stim = jsPsych.timelineVariable('stimulus');
        const top = jsPsych.timelineVariable('box_top');
        const left = jsPsych.timelineVariable('box_left');
        const width = jsPsych.timelineVariable('box_width');
        const height = jsPsych.timelineVariable('box_height');

        return `
          <div class="image-container">
            <img src="${stim}" style="width: 100%;">
            <div class="target-box"
                style="top: ${top}px; left: ${left}px; width: ${width}px; height: ${height}px;"
                onclick="if(!window.waiting) document.getElementById('hidden-btn').click();"></div>
          </div>
        `;
      },
      choices: ['Continue'],
      button_html: '<button class="hidden-button" id="hidden-btn">%choice%</button>',
      data: { task: 'response' },
      on_start: function() {
        const delay = jsPsych.randomization.sampleWithoutReplacement(
          [500, 750, 1000, 1250, 1500, 1750, 2000], 1)[0];
        window.waiting = true;
        setTimeout(() => { window.waiting = false; }, delay);
      }
    };

const test_procedure = {
  timeline: [test],
  timeline_variables: test_stimuli,
  repetitions: 3,
  randomize_order: true
};
    timeline.push(test_procedure);

    const debrief_block = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const trials = jsPsych.data.get().filter({task: 'response'});
        const rt = Math.round(trials.select('rt').mean());
        return `
          <p>You completed the experiment.</p>
          <p>Your average response time was ${rt} ms.</p>
          <p>Press any key to finish.</p>
        `;
      }
    };
    timeline.push(debrief_block);

    jsPsych.run(timeline);
  </script>
</html>